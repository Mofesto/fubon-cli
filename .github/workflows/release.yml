name: Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  # 版本管理和標籤建立
  version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      tag: ${{ steps.version_output.outputs.tag }}
      version: ${{ steps.version_output.outputs.version }}

    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.11"

    - name: Install setuptools-scm
      run: |
        python -m pip install --upgrade pip
        pip install setuptools-scm

    - name: Get version from tag
      if: github.event_name == 'release'
      id: get_version_tag
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "TAG_VERSION=v$VERSION" >> $GITHUB_ENV

    - name: Bump version and create tag
      if: github.event_name == 'workflow_dispatch'
      id: bump_version
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        # Get current version from setuptools-scm
        CURRENT_VERSION=$(python -c "import setuptools_scm; print(setuptools_scm.get_version().split('+')[0])")
        echo "Current version: $CURRENT_VERSION"

        # Extract version parts
        IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
        patch=${patch%%-*}  # Remove suffix like -dev0

        # Bump version based on input
        if [ "${{ github.event.inputs.version }}" = "major" ]; then
          NEW_VERSION="$((major + 1)).0.0"
        elif [ "${{ github.event.inputs.version }}" = "minor" ]; then
          NEW_VERSION="$major.$((minor + 1)).0"
        else
          NEW_VERSION="$major.$minor.$((patch + 1))"
        fi

        echo "New version: $NEW_VERSION"
        echo "VERSION=$NEW_VERSION" >> $GITHUB_ENV
        echo "TAG_VERSION=v$NEW_VERSION" >> $GITHUB_ENV

        # Create and push tag
        git tag "v$NEW_VERSION"
        git push origin "v$NEW_VERSION"

    - name: Set version output
      id: version_output
      run: |
        echo "tag=${{ env.TAG_VERSION }}" >> $GITHUB_OUTPUT
        echo "version=${{ env.VERSION }}" >> $GITHUB_OUTPUT

  # 發布到 PyPI
  pypi-release:
    needs: version
    runs-on: ubuntu-latest
    environment: release
    permissions:
      id-token: write
      contents: read

    steps:
    - uses: actions/checkout@v6
      with:
        ref: ${{ needs.version.outputs.tag }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.11"

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine setuptools-scm

    - name: Build package
      run: python -m build

    - name: Check package
      run: twine check dist/*

    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}
        print-hash: true

  # 建立 GitHub Release
  github-release:
    needs: [version, pypi-release]
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v6
      with:
        ref: ${{ needs.version.outputs.tag }}

    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: dist
        path: dist/
      continue-on-error: true

    - name: Create Release Notes
      run: |
        echo "## Release ${{ needs.version.outputs.version }}" > release_notes.md
        echo "" >> release_notes.md
        echo "Published to [PyPI](https://pypi.org/project/fubon-cli/${{ needs.version.outputs.version }}/)" >> release_notes.md

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.version.outputs.tag }}
        body_path: release_notes.md
        files: dist/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
