name: Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  release:
    runs-on: ubuntu-latest
    environment: release
    permissions:
      id-token: write
      contents: read

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine setuptools-scm

    - name: Get version from tag
      if: github.event_name == 'release'
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "TAG_VERSION=v$VERSION" >> $GITHUB_ENV

    - name: Bump version and create tag
      if: github.event_name == 'workflow_dispatch'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        # Get current version from setuptools-scm
        CURRENT_VERSION=$(python -c "import setuptools_scm; print(setuptools_scm.get_version().split('+')[0])")
        echo "Current version: $CURRENT_VERSION"

        # Extract version parts
        IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
        patch=${patch%%-*}  # Remove suffix like -dev0

        # Bump version based on input
        if [ "${{ github.event.inputs.version }}" = "major" ]; then
          NEW_VERSION="$((major + 1)).0.0"
        elif [ "${{ github.event.inputs.version }}" = "minor" ]; then
          NEW_VERSION="$major.$((minor + 1)).0"
        else
          NEW_VERSION="$major.$minor.$((patch + 1))"
        fi

        echo "New version: $NEW_VERSION"
        echo "VERSION=$NEW_VERSION" >> $GITHUB_ENV
        echo "TAG_VERSION=v$NEW_VERSION" >> $GITHUB_ENV

        # Create and push tag
        git tag "$TAG_VERSION"
        git push origin "$TAG_VERSION"

    - name: Build package
      run: |
        python -m build

    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        skip-existing: true

    - name: Create Release Notes
      if: github.event_name == 'workflow_dispatch'
      run: |
        echo "## Release ${{ env.VERSION }}" > release_notes.md
        echo "" >> release_notes.md
        echo "Published to [PyPI](https://pypi.org/project/fubon-cli/${{ env.VERSION }}/)" >> release_notes.md

    - name: Create GitHub Release
      if: github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.TAG_VERSION }}
        body_path: release_notes.md
        files: dist/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
